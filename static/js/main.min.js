"use strict";class BTSWebsite{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.particles=null,this.floatingShapes=[],this.audioPlayer=null,this.currentSongIndex=0,this.songs=[],this.isPlaying=!1,this.currentMemberImageIndex={},this.animationId=null,this.koreanColors={red:"#c8102e",blue:"#003478",gold:"#ffd700",pink:"#ff69b4",green:"#32cd32",white:"#ffffff",black:"#000000"},this.deviceBreakpoints={mobile:768,tablet:1024,laptop:1440,desktop:1920},this.performanceMetrics={fps:0,frameTime:0,memoryUsage:0},this.isReducedMotion=!1,this.deviceType="desktop",this.lastFrameTime=0,this.detectDeviceType(),this.checkReducedMotionPreference(),this.init(),this.setupAccessibility(),this.setupPerformanceMonitoring(),console.log(`Enhanced BTS Website initialized with Three.js background for ${this.deviceType} device`)}detectDeviceType(){const e=window.innerWidth,t=window.innerHeight,n=t>e;e<=this.deviceBreakpoints.mobile?this.deviceType="mobile":e<=this.deviceBreakpoints.tablet?this.deviceType=n?"tablet-portrait":"tablet-landscape":e<=this.deviceBreakpoints.laptop?this.deviceType="laptop":this.deviceType="desktop",n&&t>1200&&(this.deviceType="vertical-monitor")}checkReducedMotionPreference(){this.isReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches}setupAccessibility(){const e=document.getElementById("three-container");e&&(e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation")),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.pauseAnimations()})}setupPerformanceMonitoring(){let e=0,t=performance.now();const n=()=>{const i=performance.now();e++,i-t>=1e3&&(this.performanceMetrics.fps=Math.round(1e3*e/(i-t)),this.performanceMetrics.frameTime=(i-t)/e,performance.memory&&(this.performanceMetrics.memoryUsage=performance.memory.usedJSHeapSize/1048576),e=0,t=i,this.performanceMetrics.fps<30&&this.optimizeForLowPerformance()),requestAnimationFrame(n)};n()}optimizeForLowPerformance(){if(this.particles&&this.particles.geometry){const e=this.particles.geometry.attributes.position.array;if(e.length>3e3){const t=new Float32Array(3e3);for(let n=0;n<3e3;n++)t[n]=e[n];this.particles.geometry.setAttribute("position",new THREE.BufferAttribute(t,3))}}}pauseAnimations(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}init(){this.initThreeJS(),this.initMusicPlayer(),this.initHTMXHandlers(),this.initScrollEffects(),this.animate()}initThreeJS(){const e=document.getElementById("three-container");e&&(this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(0,0),e.appendChild(this.renderer.domElement),this.createParticles(),this.createFloatingShapes(),this.camera.position.z=5,window.addEventListener("resize",()=>this.onWindowResize()))}createParticles(){const e=new THREE.BufferGeometry,t=new Float32Array(600),n=new Float32Array(600);for(let e=0;e<200;e++){const i=3*e;t[i]=20*(Math.random()-.5),t[i+1]=20*(Math.random()-.5),t[i+2]=20*(Math.random()-.5);const r=new THREE.Color;r.setHSL(.3*Math.random()+.7,.8,.6),n[i]=r.r,n[i+1]=r.g,n[i+2]=r.b}e.setAttribute("position",new THREE.BufferAttribute(t,3)),e.setAttribute("color",new THREE.BufferAttribute(n,3));const i=new THREE.PointsMaterial({size:.05,vertexColors:!0,transparent:!0,opacity:.8,blending:THREE.AdditiveBlending});this.particles=new THREE.Points(e,i),this.scene?.add(this.particles)}createFloatingShapes(){const e=[new THREE.BoxGeometry(.2,.2,.2),new THREE.SphereGeometry(.1,8,6),new THREE.ConeGeometry(.1,.3,6)];for(let t=0;t<20;t++){const t=e[Math.floor(Math.random()*e.length)],n=new THREE.MeshBasicMaterial({color:(new THREE.Color).setHSL(.3*Math.random()+.7,.8,.6),transparent:!0,opacity:.3,wireframe:!0}),i=new THREE.Mesh(t,n);i.position.set(10*(Math.random()-.5),10*(Math.random()-.5),10*(Math.random()-.5)),i.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI),i.userData={rotationSpeed:{x:.02*(Math.random()-.5),y:.02*(Math.random()-.5),z:.02*(Math.random()-.5)}},this.floatingShapes.push(i),this.scene?.add(i)}}animate(){requestAnimationFrame(()=>this.animate());const e=.001*Date.now();this.particles&&(this.particles.rotation.y=.1*e,this.particles.rotation.x=.05*e),this.floatingShapes&&this.floatingShapes.forEach(t=>{t.rotation.x+=t.userData.rotationSpeed.x,t.rotation.y+=t.userData.rotationSpeed.y,t.rotation.z+=t.userData.rotationSpeed.z,t.position.y+=.001*Math.sin(e+t.position.x)}),this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera)}onWindowResize(){this.camera&&this.renderer&&(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight))}initMusicPlayer(){if(this.audioPlayer=document.getElementById("audio-player"),!this.audioPlayer)return;const e=document.getElementById("play-btn"),t=document.getElementById("prev-btn"),n=document.getElementById("next-btn");document.querySelector(".progress"),document.getElementById("current-time"),document.getElementById("duration");e&&e.addEventListener("click",()=>this.togglePlay()),t&&t.addEventListener("click",()=>this.previousSong()),n&&n.addEventListener("click",()=>this.nextSong()),this.audioPlayer&&(this.audioPlayer.addEventListener("timeupdate",()=>{this.updateProgress()}),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.updateDuration()}),this.audioPlayer.addEventListener("ended",()=>{this.nextSong()}));const i=document.querySelector(".progress-bar");i&&i.addEventListener("click",e=>{this.seekTo(e)})}togglePlay(){if(!this.audioPlayer)return;const e=document.getElementById("play-btn");this.isPlaying?(this.audioPlayer.pause(),e&&(e.textContent="▶"),this.isPlaying=!1):(this.audioPlayer.play(),e&&(e.textContent="⏸"),this.isPlaying=!0)}previousSong(){0!==this.songs.length&&(this.currentSongIndex=(this.currentSongIndex-1+this.songs.length)%this.songs.length,this.loadSong(this.songs[this.currentSongIndex]))}nextSong(){0!==this.songs.length&&(this.currentSongIndex=(this.currentSongIndex+1)%this.songs.length,this.loadSong(this.songs[this.currentSongIndex]))}loadSong(e){if(!this.audioPlayer||!e)return;this.audioPlayer.src=e.audio_url;const t=document.getElementById("current-song-title"),n=document.getElementById("current-album-art");t&&(t.textContent=e.title_korean),n&&n.src&&(n.src="/static/images/default-album.jpg"),this.isPlaying&&this.audioPlayer.play()}updateProgress(){if(!this.audioPlayer)return;const e=document.querySelector(".progress"),t=document.getElementById("current-time"),n=this.audioPlayer.currentTime,i=this.audioPlayer.duration;if(e&&i){const t=n/i*100;e.style.width=`${t}%`}t&&(t.textContent=this.formatTime(n))}updateDuration(){if(!this.audioPlayer)return;const e=document.getElementById("duration");e&&(e.textContent=this.formatTime(this.audioPlayer.duration))}seekTo(e){if(!this.audioPlayer)return;const t=e.currentTarget,n=e.offsetX/(t?.offsetWidth||0)*this.audioPlayer.duration;this.audioPlayer.currentTime=n}formatTime(e){if(isNaN(e))return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}initHTMXHandlers(){document.addEventListener("htmx:afterRequest",e=>{"members-content"===e.detail?.target?.id?this.handleMembersLoaded(e.detail.xhr.response):"songs-content"===e.detail?.target?.id&&this.handleSongsLoaded(e.detail.xhr.response)}),document.addEventListener("click",e=>{const t=e.target;if(t?.closest(".song-card")){const e=t.closest(".song-card"),n=JSON.parse(e.dataset.song||"{}");this.loadSong(n)}})}handleMembersLoaded(e){try{const t=JSON.parse(e);this.renderMembers(t)}catch(e){console.error("Error parsing members data:",e)}}handleSongsLoaded(e){try{const t=JSON.parse(e),n=this.validateApiData(t);Array.isArray(n)&&n.length>0?(this.songs=n,this.renderSongs(n)):this.showErrorMessage("songs-content","음악 데이터를 불러올 수 없습니다.")}catch(e){console.error("Error parsing songs data:",e),this.showErrorMessage("songs-content","음악 데이터 파싱 오류가 발생했습니다.")}}handleAlbumsLoaded(e){try{const t=JSON.parse(e),n=this.validateApiData(t);Array.isArray(n)&&n.length>0?this.renderAlbums(n):this.showErrorMessage("albums-content","앨범 데이터를 불러올 수 없습니다.")}catch(e){console.error("Error parsing albums data:",e),this.showErrorMessage("albums-content","앨범 데이터 파싱 오류가 발생했습니다.")}}showErrorMessage(e,t){const n=document.getElementById(e);if(!n)return;n.innerHTML="";const i=document.createElement("div");i.className="error-message",i.textContent=this.sanitizeText(t),n.appendChild(i)}renderMembers(e){const t=document.getElementById("members-content");if(!t)return;const n=document.createDocumentFragment();e.forEach(e=>{this.currentMemberImageIndex[e.id]=0;const t=document.createElement("div");t.className="member-card",t.setAttribute("data-member-id",e.id.toString());const i=document.createElement("div");i.className="member-image-gallery";const r=document.createElement("div");r.className="image-container";const a=document.createElement("img");a.src=this.sanitizeUrl(e.image_urls[0]),a.alt=this.sanitizeText(e.name_korean),a.loading="lazy",a.className="member-image";const s=document.createElement("div");s.className="image-nav";const o=document.createElement("button");o.className="prev-image",o.textContent="‹",o.addEventListener("click",()=>this.previousMemberImage(e.id));const c=document.createElement("button");c.className="next-image",c.textContent="›",c.addEventListener("click",()=>this.nextMemberImage(e.id));const d=document.createElement("div");d.className="image-dots",e.image_urls.forEach((t,n)=>{const i=document.createElement("span");i.className="dot "+(0===n?"active":""),i.addEventListener("click",()=>this.setMemberImage(e.id,n)),d.appendChild(i)}),s.appendChild(o),s.appendChild(d),s.appendChild(c),r.appendChild(a),r.appendChild(s),i.appendChild(r);const l=document.createElement("div");l.className="member-info";const m=document.createElement("h3");m.textContent=`${this.sanitizeText(e.name_korean)} (${this.sanitizeText(e.name_english)})`;const h=document.createElement("p");h.className="position",h.textContent=this.sanitizeText(e.position);const u=document.createElement("p");u.className="description",u.textContent=this.sanitizeText(e.description_korean);const p=document.createElement("div");if(p.className="social-links",e.social_media_links.twitter){const t=document.createElement("a");t.href=`https://twitter.com/${this.sanitizeText(e.social_media_links.twitter)}`,t.target="_blank",t.rel="noopener noreferrer",t.className="social-link twitter",t.textContent="Twitter",p.appendChild(t)}if(e.social_media_links.instagram){const t=document.createElement("a");t.href=`https://instagram.com/${this.sanitizeText(e.social_media_links.instagram)}`,t.target="_blank",t.rel="noopener noreferrer",t.className="social-link instagram",t.textContent="Instagram",p.appendChild(t)}if(e.social_media_links.weverse){const e=document.createElement("a");e.href="https://weverse.io/bts",e.target="_blank",e.rel="noopener noreferrer",e.className="social-link weverse",e.textContent="Weverse",p.appendChild(e)}l.appendChild(m),l.appendChild(h),l.appendChild(u),l.appendChild(p),t.appendChild(i),t.appendChild(l),n.appendChild(t)}),t.innerHTML="",t.appendChild(n)}nextMemberImage(e){const t=document.querySelector(`[data-member-id="${e}"]`);if(!t)return;const n=t.querySelector(".member-image"),i=t.querySelectorAll(".dot");if(!n||!i.length)return;const r=((this.currentMemberImageIndex[e]||0)+1)%i.length;this.setMemberImage(e,r)}previousMemberImage(e){const t=document.querySelector(`[data-member-id="${e}"]`);if(!t)return;const n=t.querySelector(".member-image"),i=t.querySelectorAll(".dot");if(!n||!i.length)return;const r=this.currentMemberImageIndex[e]||0,a=0===r?i.length-1:r-1;this.setMemberImage(e,a)}setMemberImage(e,t){const n=document.querySelector(`[data-member-id="${e}"]`);if(!n)return;const i=n.querySelector(".member-image"),r=n.querySelectorAll(".dot");if(!i||!r.length)return;const a=[`/static/images/${this.getMemberName(e)}_1.jpg`,`/static/images/${this.getMemberName(e)}_2.jpg`,`/static/images/${this.getMemberName(e)}_3.jpg`];i.src=a[t],this.currentMemberImageIndex[e]=t,r.forEach((e,n)=>{e.classList.toggle("active",n===t)})}getMemberName(e){return["rm","jin","suga","jhope","jimin","v","jungkook"][e-1]||"rm"}renderSongs(e){const t=document.getElementById("songs-content");if(!t)return;const n=document.createDocumentFragment();e.forEach((e,t)=>{const i=document.createElement("div");i.className="song-card",i.setAttribute("data-song",JSON.stringify(e)),i.setAttribute("data-index",t.toString());const r=document.createElement("h3");r.className="song-title",r.textContent=this.sanitizeText(e.title_korean);const a=document.createElement("p");a.className="song-album",a.textContent=`앨범: ${this.sanitizeText(e.album)}`;const s=document.createElement("p");s.className="song-date",s.textContent=new Date(e.release_date).toLocaleDateString("ko-KR"),i.appendChild(r),i.appendChild(a),i.appendChild(s),n.appendChild(i)}),t.innerHTML="",t.appendChild(n)}initScrollEffects(){const e=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.style.opacity="1",e.target.style.transform="translateY(0)")})},{threshold:.1,rootMargin:"0px 0px -50px 0px"});document.querySelectorAll("section").forEach(t=>{t.style.opacity="0",t.style.transform="translateY(50px)",t.style.transition="opacity 0.6s ease, transform 0.6s ease",e.observe(t)}),document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("href")?.substring(1)||"",i=document.getElementById(n);i&&i.scrollIntoView({behavior:"smooth",block:"start"})})})}debounce(e,t){let n;return function(...i){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...i)},t)}}throttle(e,t){let n;return function(...i){n||(e.apply(this,i),n=!0,setTimeout(()=>n=!1,t))}}sanitizeText(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").substring(0,500)}sanitizeUrl(e){if("string"!=typeof e)return"/static/images/default.jpg";try{const t=new URL(e,window.location.origin);if("http:"===t.protocol||"https:"===t.protocol)return t.href}catch(t){if(e.startsWith("/static/"))return e.substring(0,200)}return"/static/images/default.jpg"}validateApiData(e){if(!e||"object"!=typeof e)return null;if(Array.isArray(e))return e.map(e=>this.validateApiData(e)).filter(Boolean);const t={};for(const[n,i]of Object.entries(e))"__proto__"!==n&&"constructor"!==n&&"prototype"!==n&&("string"==typeof i?t[n]=this.sanitizeText(i):"number"==typeof i&&isFinite(i)?t[n]=i:"object"==typeof i&&null!==i&&(t[n]=this.validateApiData(i)));return t}renderAlbums(e){const t=document.getElementById("albums-content");if(!t)return;const n=document.createDocumentFragment();e.forEach(e=>{const t=document.createElement("div");t.className="album-card";const i=document.createElement("div");i.className="album-cover";const r=document.createElement("img");r.src=this.sanitizeUrl(e.cover_image_url),r.alt=this.sanitizeText(e.title_korean),r.loading="lazy",i.appendChild(r);const a=document.createElement("div");a.className="album-info";const s=document.createElement("h3");s.className="album-title",s.textContent=this.sanitizeText(e.title_korean);const o=document.createElement("p");o.className="album-date",o.textContent=new Date(e.release_date).toLocaleDateString("ko-KR");const c=document.createElement("p");c.className="album-description",c.textContent=this.sanitizeText(e.description_korean),a.appendChild(s),a.appendChild(o),a.appendChild(c),t.appendChild(i),t.appendChild(a),n.appendChild(t)}),t.innerHTML="",t.appendChild(n)}}document.addEventListener("DOMContentLoaded",()=>{const e=new BTSWebsite;window.btsWebsite=e}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/static/js/sw.js").then(e=>{console.log("SW registered: ",e)}).catch(e=>{console.log("SW registration failed: ",e)})});