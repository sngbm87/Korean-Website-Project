import*as THREE from"three";class BTSWebsite{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.particles=null,this.floatingShapes=[],this.audioPlayer=null,this.currentSongIndex=0,this.songs=[],this.isPlaying=!1,this.init()}init(){this.initThreeJS(),this.initMusicPlayer(),this.initHTMXHandlers(),this.initScrollEffects(),this.animate()}initThreeJS(){const e=document.getElementById("three-container");e&&(this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(0,0),e.appendChild(this.renderer.domElement),this.createParticles(),this.createFloatingShapes(),this.camera.position.z=5,window.addEventListener("resize",()=>this.onWindowResize()))}createParticles(){const e=new THREE.BufferGeometry,t=new Float32Array(600),n=new Float32Array(600);for(let e=0;e<200;e++){const r=3*e;t[r]=20*(Math.random()-.5),t[r+1]=20*(Math.random()-.5),t[r+2]=20*(Math.random()-.5);const i=new THREE.Color;i.setHSL(.3*Math.random()+.7,.8,.6),n[r]=i.r,n[r+1]=i.g,n[r+2]=i.b}e.setAttribute("position",new THREE.BufferAttribute(t,3)),e.setAttribute("color",new THREE.BufferAttribute(n,3));const r=new THREE.PointsMaterial({size:.05,vertexColors:!0,transparent:!0,opacity:.8,blending:THREE.AdditiveBlending});this.particles=new THREE.Points(e,r),this.scene?.add(this.particles)}createFloatingShapes(){const e=[new THREE.BoxGeometry(.2,.2,.2),new THREE.SphereGeometry(.1,8,6),new THREE.ConeGeometry(.1,.3,6)];for(let t=0;t<20;t++){const t=e[Math.floor(Math.random()*e.length)],n=new THREE.MeshBasicMaterial({color:(new THREE.Color).setHSL(.3*Math.random()+.7,.8,.6),transparent:!0,opacity:.3,wireframe:!0}),r=new THREE.Mesh(t,n);r.position.set(10*(Math.random()-.5),10*(Math.random()-.5),10*(Math.random()-.5)),r.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI),r.userData={rotationSpeed:{x:.02*(Math.random()-.5),y:.02*(Math.random()-.5),z:.02*(Math.random()-.5)}},this.floatingShapes.push(r),this.scene?.add(r)}}animate(){requestAnimationFrame(()=>this.animate());const e=.001*Date.now();this.particles&&(this.particles.rotation.y=.1*e,this.particles.rotation.x=.05*e),this.floatingShapes&&this.floatingShapes.forEach(t=>{t.rotation.x+=t.userData.rotationSpeed.x,t.rotation.y+=t.userData.rotationSpeed.y,t.rotation.z+=t.userData.rotationSpeed.z,t.position.y+=.001*Math.sin(e+t.position.x)}),this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera)}onWindowResize(){this.camera&&this.renderer&&(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight))}initMusicPlayer(){if(this.audioPlayer=document.getElementById("audio-player"),!this.audioPlayer)return;const e=document.getElementById("play-btn"),t=document.getElementById("prev-btn"),n=document.getElementById("next-btn");document.querySelector(".progress"),document.getElementById("current-time"),document.getElementById("duration");e&&e.addEventListener("click",()=>this.togglePlay()),t&&t.addEventListener("click",()=>this.previousSong()),n&&n.addEventListener("click",()=>this.nextSong()),this.audioPlayer&&(this.audioPlayer.addEventListener("timeupdate",()=>{this.updateProgress()}),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.updateDuration()}),this.audioPlayer.addEventListener("ended",()=>{this.nextSong()}));const r=document.querySelector(".progress-bar");r&&r.addEventListener("click",e=>{this.seekTo(e)})}togglePlay(){if(!this.audioPlayer)return;const e=document.getElementById("play-btn");this.isPlaying?(this.audioPlayer.pause(),e&&(e.textContent="▶"),this.isPlaying=!1):(this.audioPlayer.play(),e&&(e.textContent="⏸"),this.isPlaying=!0)}previousSong(){0!==this.songs.length&&(this.currentSongIndex=(this.currentSongIndex-1+this.songs.length)%this.songs.length,this.loadSong(this.songs[this.currentSongIndex]))}nextSong(){0!==this.songs.length&&(this.currentSongIndex=(this.currentSongIndex+1)%this.songs.length,this.loadSong(this.songs[this.currentSongIndex]))}loadSong(e){if(!this.audioPlayer||!e)return;this.audioPlayer.src=e.audio_url;const t=document.getElementById("current-song-title"),n=document.getElementById("current-album-art");t&&(t.textContent=e.title_korean),n&&n.src&&(n.src="/static/images/default-album.jpg"),this.isPlaying&&this.audioPlayer.play()}updateProgress(){if(!this.audioPlayer)return;const e=document.querySelector(".progress"),t=document.getElementById("current-time"),n=this.audioPlayer.currentTime,r=this.audioPlayer.duration;if(e&&r){const t=n/r*100;e.style.width=`${t}%`}t&&(t.textContent=this.formatTime(n))}updateDuration(){if(!this.audioPlayer)return;const e=document.getElementById("duration");e&&(e.textContent=this.formatTime(this.audioPlayer.duration))}seekTo(e){if(!this.audioPlayer)return;const t=e.currentTarget,n=e.offsetX/(t?.offsetWidth||0)*this.audioPlayer.duration;this.audioPlayer.currentTime=n}formatTime(e){if(isNaN(e))return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}initHTMXHandlers(){document.addEventListener("htmx:afterRequest",e=>{"members-content"===e.detail?.target?.id?this.handleMembersLoaded(e.detail.xhr.response):"songs-content"===e.detail?.target?.id&&this.handleSongsLoaded(e.detail.xhr.response)}),document.addEventListener("click",e=>{const t=e.target;if(t?.closest(".song-card")){const e=t.closest(".song-card"),n=JSON.parse(e.dataset.song||"{}");this.loadSong(n)}})}handleMembersLoaded(e){try{const t=JSON.parse(e);this.renderMembers(t)}catch(e){console.error("Error parsing members data:",e)}}handleSongsLoaded(e){try{const t=JSON.parse(e);this.songs=t,this.renderSongs(t)}catch(e){console.error("Error parsing songs data:",e)}}renderMembers(e){const t=document.getElementById("members-content");t&&(t.innerHTML=e.map(e=>`\n            <div class="member-card" data-member-id="${e.id}">\n                <img src="${e.image_url}" alt="${e.name_korean}" class="member-image" \n                     onerror="this.src='/static/images/default-member.jpg'">\n                <h3 class="member-name">${e.name_korean} (${e.name_english})</h3>\n                <p class="member-position">${e.position}</p>\n                <p class="member-description">${e.description_korean}</p>\n            </div>\n        `).join(""))}renderSongs(e){const t=document.getElementById("songs-content");t&&(t.innerHTML=e.map((e,t)=>`\n            <div class="song-card" data-song='${JSON.stringify(e)}' data-index="${t}">\n                <h3 class="song-title">${e.title_korean}</h3>\n                <p class="song-album">앨범: ${e.album}</p>\n                <p class="song-date">${new Date(e.release_date).toLocaleDateString("ko-KR")}</p>\n            </div>\n        `).join(""))}initScrollEffects(){const e=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.style.opacity="1",e.target.style.transform="translateY(0)")})},{threshold:.1,rootMargin:"0px 0px -50px 0px"});document.querySelectorAll("section").forEach(t=>{t.style.opacity="0",t.style.transform="translateY(50px)",t.style.transition="opacity 0.6s ease, transform 0.6s ease",e.observe(t)}),document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("href")?.substring(1)||"",r=document.getElementById(n);r&&r.scrollIntoView({behavior:"smooth",block:"start"})})})}debounce(e,t){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...r)},t)}}throttle(e,t){let n;return function(...r){n||(e.apply(this,r),n=!0,setTimeout(()=>n=!1,t))}}}document.addEventListener("DOMContentLoaded",()=>{new BTSWebsite}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/static/js/sw.js").then(e=>{console.log("SW registered: ",e)}).catch(e=>{console.log("SW registration failed: ",e)})});